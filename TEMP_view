// Tab switching by showing/hiding pre-authored sections in the DOM
(function () {
  const content = document.getElementById('content');
  const tabs = Array.from(document.querySelectorAll('.sidebar .tab'));
  const panels = Array.from(document.querySelectorAll('.content .panel'));

  const validKeys = new Set(panels.map(p => p.dataset.key));

  function setActiveLink(key) {
    tabs.forEach(a => {
      const isActive = a.dataset.tab === key;
      if (isActive) {
        a.setAttribute('aria-current', 'page');
      } else {
        a.removeAttribute('aria-current');
      }
    });
  }

  function showPanel(key) {
    panels.forEach(p => {
      p.hidden = p.dataset.key !== key;
    });
    setActiveLink(key);
    // Toggle homepage theme based on active key
    document.body.classList.toggle('home-theme', key === 'home');

    // When viewing Matt Newell panel, randomize bin link positions
    if (key === 'matt-newell') {
      randomizeBinLinks();
    }
    // When viewing Photography, build the grid if needed
    if (key === 'photography') {
      buildPhotoGrid();
    }
  }

  function resetScrollTop() {
    const el = document.scrollingElement || document.documentElement || document.body;
    if (typeof el.scrollTo === 'function') {
      el.scrollTo({ top: 0, left: 0, behavior: 'auto' });
    } else {
      el.scrollTop = 0;
      if (document.body) document.body.scrollTop = 0;
    }
  }

  function getKeyFromHash() {
    const hash = (location.hash || '#home').slice(1);
    return validKeys.has(hash) ? hash : 'home';
  }

  // Initialize
  const hadHash = !!location.hash;
  let current = getKeyFromHash();
  showPanel(current);
  // If no hash on first load, do not highlight any tab
  if (!hadHash) {
    tabs.forEach(a => a.removeAttribute('aria-current'));
  }

  // Randomize overlay links on the bin image, keeping them near center
  function randomizeBinLinks() {
    const container = document.querySelector('.bin-collage');
    if (!container) return;
    const links = Array.from(container.querySelectorAll('.bin-link'));
    if (!links.length) return;
    // Place each link within ~40%..60% of width/height (near center)
    links.forEach(a => {
      const leftPct = 30 + Math.random() * 40;
      const topPct = 20 + Math.random() * 60;
      const rot = Math.floor(-90 + Math.random() * 170); // any rotation
      a.style.left = leftPct + '%';
      a.style.top = topPct + '%';
      a.style.transform = `translate(-50%, -50%) rotate(${rot}deg)`;
    });
  }

  // Keep positions reasonable on resize when Matt Newell is active
  window.addEventListener('resize', () => {
    if (current === 'matt-newell') {
      randomizeBinLinks();
    }
  });

  // Click handlers (also keep hash in sync)
  tabs.forEach(a => {
    a.addEventListener('click', (e) => {
      e.preventDefault();
      const key = a.dataset.tab;
      if (!key) return;
      if (key !== current) {
        current = key;
        history.replaceState(null, '', `#${key}`);
        showPanel(key);
      }
      // Always reset page scroll to top on tab click
      resetScrollTop();
      content.focus({ preventScroll: true });
    });
  });

  // Respond to manual hash changes (e.g., back/forward)
  window.addEventListener('hashchange', () => {
    const key = getKeyFromHash();
    if (key !== current) {
      current = key;
      showPanel(key);
    }
  });
})();

// Photography grid population (images shuffled, 3 columns, center offset)
(() => {
  const PHOTO_DIR = 'photography/';
  // Hardcoded list of files in the photography folder (randomized on render)
  const PHOTO_FILES = [
    'photography-h1.jpg','photography-h2.jpg','photography-h3.jpg',
    'photography1.jpg','photography2.jpg','photography3.jpg','photography4.jpg','photography5.jpg','photography6.jpg','photography7.jpg','photography8.jpg','photography9.jpg','photography10.jpg','photography12.jpg','photography13.jpg','photography15.jpg','photography16.jpg','photography17.jpg','photography18.jpg','photography19.jpg','photography20.jpg','photography21.jpg','photography23.jpg','photography24.jpg','photography25.jpg','photography26.jpg','photography27.jpg','photography28.jpg','photography29.jpg','photography30.jpg','photography31.jpg','photography32.jpg','photography33.jpg','photography34.jpg','photography35.jpg','photography36.jpg','photography37.jpg','photography38.jpg','photography39.jpg','photography40.jpg','photography41.jpg'
  ];

  let gridBuilt = false;

  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function makeImg(src) {
    const img = document.createElement('img');
    img.loading = 'lazy';
    img.decoding = 'async';
    img.src = PHOTO_DIR + src;
    img.alt = '';
    img.className = 'photo-item';
    return img;
  }

  function ensureColumns(container, count) {
    if (container.children.length >= count) return Array.from(container.children);
    const cols = [];
    for (let i = 0; i < count; i++) {
      const col = document.createElement('div');
      col.className = 'photo-col';
      container.appendChild(col);
      cols.push(col);
    }
    return cols;
  }

  window.buildPhotoGrid = function buildPhotoGrid() {
    if (gridBuilt) return;
    const grid = document.getElementById('photoGrid');
    if (!grid) return;
    const cols = ensureColumns(grid, 3);
    const files = shuffle(PHOTO_FILES.slice());
    files.forEach((file, idx) => {
      const col = cols[idx % 3];
      col.appendChild(makeImg(file));
    });
    gridBuilt = true;
  }
})();
